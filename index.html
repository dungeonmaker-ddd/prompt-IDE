<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–‡ä»¶ç³»ç»Ÿæµè§ˆå™¨</title>
  <style>
    /* åŸºæœ¬æ ·å¼ */
    body {
      font-family: Arial, sans-serif;
      padding: 0;
      margin: 0;
      background-color: #f5f5f5;
      display: flex;
      min-height: 100vh;
    }

    /* å·¦ä¾§è°ƒè¯•é¢æ¿ */
    .debug-panel {
      width: 280px;
      background-color: #263238;
      color: #fff;
      padding: 15px;
      box-sizing: border-box;
      overflow-y: auto;
      height: 100vh;
      position: sticky;
      top: 0;
    }

    .debug-panel h2 {
      font-size: 18px;
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #455A64;
    }

    .debug-section {
      margin-bottom: 20px;
    }

    .debug-section h3 {
      font-size: 14px;
      color: #81D4FA;
      margin-top: 0;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .debug-content {
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      background-color: #1E272C;
      padding: 10px;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      color: #A5D6A7;
    }

    .debug-content.json {
      color: #FFD54F;
    }

    .debug-count {
      background-color: #455A64;
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 11px;
      margin-left: 5px;
    }

    /* ä¸»å†…å®¹åŒºåŸŸ */
    .main-content {
      flex-grow: 1;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      height: 100vh;
    }

    /* æ§åˆ¶åŒºåŸŸ */
    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button.danger {
      background-color: #f44336;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    /* å¸ƒå±€å®¹å™¨ - ç”µè·¯æ¿é£æ ¼ */
    .board-container {
      position: relative;
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      margin-bottom: 20px;
      padding: 20px;
      background-color: #f0f0f0;
      border-radius: 10px;
      border: 1px solid #ddd;
      min-height: 400px;
    }

    /* æ ¹ç›®å½•åŒºåŸŸ */
    .root-directory-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative;
    }

    /* ç›®å½•å¡ç‰‡æ ·å¼ */
    .directory-card {
      position: relative;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      width: 600px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      background-color: white;
      margin-left: 30px;
      z-index: 2;
      transition: box-shadow 0.3s, border-radius 0.3s;
    }

    /* å¡ç‰‡å†…å®¹åŒºåŸŸå¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
    .card-content {
      transition: height 0.3s ease-out, opacity 0.3s ease-out;
      overflow: hidden;
      display: flex;
      height: 300px;
    }

    /* æ”¶èµ·çŠ¶æ€çš„å¡ç‰‡å†…å®¹æ ·å¼ */
    .directory-card.card-collapsed .card-content {
      height: 0 !important;
      opacity: 0;
      padding: 0;
      margin: 0;
      border: none;
    }

    /* æ”¶èµ·çŠ¶æ€ä¸‹æ ‡é¢˜æ åº•éƒ¨è¾¹æ¡†éšè— */
    .directory-card.card-collapsed .card-header {
      border-bottom: none;
    }

    /* æ”¶èµ·çŠ¶æ€çš„å¡ç‰‡æ ·å¼ */
    .directory-card.card-collapsed {
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    /* æ ¹ç›®å½•å¡ç‰‡ */
    .directory-card.root {
      margin-left: 0;
    }

    /* å¡ç‰‡è¿æ¥çº¿ */
    .card-connector {
      position: absolute;
      border: 2px solid #4285f4;
      z-index: 1;
    }

    .connector-horizontal {
      height: 2px;
      background-color: #4285f4;
    }

    .connector-vertical {
      width: 2px;
      background-color: #4285f4;
    }

    /* å¡ç‰‡èŠ‚ç‚¹ç‚¹ */
    .connector-node {
      position: absolute;
      width: 8px;
      height: 8px;
      background-color: #4285f4;
      border-radius: 50%;
      z-index: 1;
    }

    .card-header {
      background-color: #4285f4;
      padding: 12px;
      border-bottom: 1px solid #ddd;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .root .card-header {
      background-color: #FF5722;
    }

    .card-title-section {
      flex-grow: 1;
    }

    .card-title {
      margin: 0;
      font-size: 16px;
      font-weight: bold;
    }

    .card-info {
      font-size: 12px;
      margin-top: 5px;
      color: rgba(255, 255, 255, 0.8);
    }

    /* å¡ç‰‡æ“ä½œæŒ‰é’® */
    .card-actions {
      display: flex;
      gap: 5px;
    }

    .card-collapse-btn, .card-close-btn {
      background-color: transparent;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 0;
    }

    .card-collapse-btn:hover, .card-close-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .content-left {
      flex: 1;
      border-right: 1px solid #eee;
      overflow-y: auto;
    }

    .content-right {
      flex: 1;
      overflow-y: auto;
      background-color: #f9f9f9;
    }

    .content-right-header {
      padding: 10px;
      background-color: #E3F2FD;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
      color: #0D47A1;
    }

    /* æ–‡ä»¶é¡¹æ ·å¼ */
    .file-item, .directory-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .file-item:hover, .directory-item:hover {
      background-color: #f0f0f0;
    }

    .directory-item {
      color: #4285f4;
    }

    .item-icon {
      margin-right: 8px;
      font-size: 16px;
    }

    /* é€‰ä¸­é¡¹æ ·å¼ */
    .selected-item {
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
      background-color: #E8F5E9;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .selected-item .item-name {
      display: flex;
      align-items: center;
    }

    .remove-item {
      background-color: transparent;
      color: #f44336;
      border: none;
      cursor: pointer;
      padding: 0;
      font-size: 16px;
      font-weight: bold;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .remove-item:hover {
      background-color: rgba(244, 67, 54, 0.1);
    }

    .empty-selection {
      padding: 20px;
      color: #757575;
      text-align: center;
      font-style: italic;
    }

    /* æ–‡ä»¶ç¼–è¾‘åŒºåŸŸ */
    .editor-container {
      margin-top: 20px;
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .editor-label {
      margin-bottom: 10px;
      font-weight: bold;
      color: #4285f4;
    }

    textarea {
      width: 100%;
      height: 300px;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
    }

    /* çŠ¶æ€æ¶ˆæ¯ */
    .status-message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background-color: #e3f2fd;
      color: #0d47a1;
    }

    /* å³é”®èœå• */
    .context-menu {
      position: absolute;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      padding: 5px 0;
      z-index: 1000;
    }

    .context-menu-item {
      padding: 8px 12px;
      cursor: pointer;
    }

    .context-menu-item:hover {
      background-color: #f0f0f0;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1200px) {
      body {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<!-- å·¦ä¾§è°ƒè¯•é¢æ¿ -->
<div class="debug-panel">
  <h2>è°ƒè¯•é¢æ¿</h2>
  <div class="debug-section">
    <h3>å·²æ‰“å¼€ç›®å½• <span id="openedDirCount" class="debug-count">0</span></h3>
    <div id="openedDirectoriesDebug" class="debug-content json"></div>
  </div>
  <div class="debug-section">
    <h3>ç›®å½•å…³ç³» <span id="relationshipsCount" class="debug-count">0</span></h3>
    <div id="relationshipsDebug" class="debug-content json"></div>
  </div>
  <div class="debug-section">
    <h3>æ ¹ç›®å½• <span id="rootDirCount" class="debug-count">0</span></h3>
    <div id="rootDirectoriesDebug" class="debug-content json"></div>
  </div>
  <div class="debug-section">
    <h3>å·²é€‰æ‹©é¡¹ç›® <span id="selectedItemsCount" class="debug-count">0</span></h3>
    <div id="selectedItemsDebug" class="debug-content json"></div>
  </div>
  <div class="debug-section">
    <h3>ç›®å½•å¥æŸ„æ˜ å°„ <span id="dirHandleMapCount" class="debug-count">0</span></h3>
    <div id="dirHandleMapDebug" class="debug-content json"></div>
  </div>
  <div class="debug-section">
    <h3>å…¨å±€å˜é‡</h3>
    <div id="globalVarsDebug" class="debug-content json"></div>
  </div>
</div>

<!-- ä¸»å†…å®¹åŒºåŸŸ -->
<div class="main-content">
  <div class="controls">
    <button id="addDirectoryButton">æ·»åŠ ç›®å½•</button>
    <button class="danger" id="clearAllButton">æ¸…ç©ºæ‰€æœ‰å¡ç‰‡</button>
    <button id="saveChangesButton" disabled>ä¿å­˜æ›´æ”¹</button>
    <!-- åŠ¨æ€æ·»åŠ æŠ˜å /å±•å¼€æ‰€æœ‰æŒ‰é’® -->
  </div>

  <div id="statusMessage" class="status-message" style="display: none;"></div>

  <!-- ç”µè·¯æ¿æ ·å¼çš„ç›®å½•å±•ç¤ºåŒºåŸŸ -->
  <div class="board-container" id="boardContainer"></div>

  <!-- æ–‡ä»¶ç¼–è¾‘åŒºåŸŸ -->
  <div class="editor-container">
    <textarea id="fileContentEditor" disabled placeholder="é€‰æ‹©æ–‡ä»¶ä»¥æŸ¥çœ‹å†…å®¹..."></textarea>
  </div>
</div>

<script>
  // å…¨å±€å˜é‡
  const openedDirectories = new Map(); // å·²æ‰“å¼€çš„ç›®å½•
  const directoryRelationships = new Map(); // å­ç›®å½•ä¸çˆ¶ç›®å½•çš„å…³ç³»
  const rootDirectories = new Set(); // æ ¹ç›®å½•IDé›†åˆ
  const selectedItemsPerCard = new Map(); // æ¯ä¸ªå¡ç‰‡é€‰ä¸­çš„é¡¹ç›®
  const dirHandleMap = new Map(); // ç›®å½•å¥æŸ„æ˜ å°„
  let currentFileHandle = null; // å½“å‰æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„

  // å¼•ç”¨DOMå…ƒç´ 
  const boardContainer = document.getElementById('boardContainer');
  const fileContentEditor = document.getElementById('fileContentEditor');
  const saveChangesButton = document.getElementById('saveChangesButton');
  const statusMessageElement = document.getElementById('statusMessage');

  // ç»‘å®šäº‹ä»¶
  document.getElementById('addDirectoryButton').addEventListener('click', handleDirectorySelectionAndDisplay);
  document.getElementById('clearAllButton').addEventListener('click', clearAllCards);
  document.getElementById('saveChangesButton').addEventListener('click', handleSaveFileChanges);

  // æ·»åŠ æŠ˜å æ‰€æœ‰æŒ‰é’®
  addCollapseAllButton();

  /**
   * @function updateDebugPanel
   * @description æ›´æ–°è°ƒè¯•é¢æ¿çš„å†…å®¹ï¼Œæ˜¾ç¤ºåŸå§‹æ•°æ®ç»“æ„
   */
  function updateDebugPanel() {
    // è½¬æ¢ Map å’Œ Set ä¸ºå¯¹è±¡å’Œæ•°ç»„ä»¥ä¾¿æ›´å¥½åœ°å±•ç¤º
    // openedDirectories Map
    const openedDirsObj = {};
    for (const [key, value] of openedDirectories.entries()) {
      openedDirsObj[key] = value;
    }
    openedDirectoriesDebug.textContent = JSON.stringify(openedDirsObj, null, 2);
    openedDirCount.textContent = openedDirectories.size;

    // directoryRelationships Map
    const relationshipsObj = {};
    for (const [key, value] of directoryRelationships.entries()) {
      relationshipsObj[key] = value;
    }
    relationshipsDebug.textContent = JSON.stringify(relationshipsObj, null, 2);
    relationshipsCount.textContent = directoryRelationships.size;

    // rootDirectories Set
    rootDirectoriesDebug.textContent = JSON.stringify([...rootDirectories], null, 2);
    rootDirCount.textContent = rootDirectories.size;

    // selectedItemsPerCard Map
    const selectedItemsObj = {};
    for (const [key, value] of selectedItemsPerCard.entries()) {
      selectedItemsObj[key] = [...value];
    }
    selectedItemsDebug.textContent = JSON.stringify(selectedItemsObj, null, 2);
    selectedItemsCount.textContent = selectedItemsPerCard.size;

    // dirHandleMap
    const dirHandleObj = {};
    for (const [key, value] of dirHandleMap.entries()) {
      dirHandleObj[key] = value.name; // åªæ˜¾ç¤ºç›®å½•åç§°ä»¥å‡å°‘ä¿¡æ¯é‡
    }
    dirHandleMapDebug.textContent = JSON.stringify(dirHandleObj, null, 2);
    dirHandleMapCount.textContent = dirHandleMap.size;

    // å…¨å±€å˜é‡
    const globalVars = {
      currentFileHandle: currentFileHandle ? currentFileHandle.name : null
    };
    globalVarsDebug.textContent = JSON.stringify(globalVars, null, 2);
  }

  /**
   * @function isDirectoryAlreadyOpen
   * @description æ£€æŸ¥ç›®å½•æ˜¯å¦å·²ç»æ‰“å¼€
   * @param {FileSystemDirectoryHandle} dirHandle ç›®å½•å¥æŸ„
   * @returns {boolean} ç›®å½•æ˜¯å¦å·²ç»æ‰“å¼€
   */
  async function isDirectoryAlreadyOpen(dirHandle) {
    // å°è¯•è·å–å”¯ä¸€æ ‡è¯†ç¬¦
    try {
      // ä½¿ç”¨ç›®å½•åç§°ä½œä¸ºç®€å•çš„æ ‡è¯†ç¬¦
      // åœ¨å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„é€»è¾‘æ¥ç¡®å®šå”¯ä¸€æ€§
      const path = dirHandle.name;
      return dirHandleMap.has(path);
    } catch (error) {
      console.error('æ£€æŸ¥ç›®å½•æ˜¯å¦å·²æ‰“å¼€æ—¶å‡ºé”™', error);
      return false;
    }
  }

  /**
   * @function getExistingCardId
   * @description è·å–å·²æ‰“å¼€ç›®å½•çš„å¡ç‰‡ID
   * @param {FileSystemDirectoryHandle} dirHandle ç›®å½•å¥æŸ„
   * @returns {string|null} å¡ç‰‡IDï¼Œå¦‚æœæœªæ‰“å¼€åˆ™è¿”å›null
   */
  function getExistingCardId(dirHandle) {
    try {
      const path = dirHandle.name;
      return dirHandleMap.has(path) ? openedDirectories.get(path) : null;
    } catch (error) {
      console.error('è·å–å·²å­˜åœ¨å¡ç‰‡IDæ—¶å‡ºé”™', error);
      return null;
    }
  }

  /**
   * @function createRootContainer
   * @description åˆ›å»ºæ ¹ç›®å½•å®¹å™¨
   * @returns {string} å®¹å™¨ID
   */
  function createRootContainer() {
    const containerId = 'root-container-' + Date.now();
    const container = document.createElement('div');
    container.className = 'root-directory-container';
    container.id = containerId;
    boardContainer.appendChild(container);
    return containerId;
  }

  /**
   * @function createDirectoryCard
   * @description åˆ›å»ºç›®å½•å¡ç‰‡
   * @param {string} directoryName ç›®å½•åç§°
   * @param {FileSystemDirectoryHandle} dirHandle ç›®å½•å¥æŸ„
   * @param {string|null} parentCardId çˆ¶å¡ç‰‡ID
   * @param {string|null} containerID å®¹å™¨ID
   * @returns {HTMLElement} åˆ›å»ºçš„å¡ç‰‡å…ƒç´ 
   */
  function createDirectoryCard(directoryName, dirHandle, parentCardId = null, containerID = null) {
    const cardId = 'card-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
    const card = document.createElement('div');
    card.className = 'directory-card';
    card.id = cardId;

    // å¦‚æœæ˜¯æ ¹ç›®å½•å¡ç‰‡
    if (!parentCardId) {
      card.classList.add('root');
      rootDirectories.add(cardId);
    } else {
      // å»ºç«‹çˆ¶å­å…³ç³»
      directoryRelationships.set(cardId, parentCardId);
    }

    // åˆ›å»ºå¡ç‰‡å¤´éƒ¨
    const header = document.createElement('div');
    header.className = 'card-header';

    const titleSection = document.createElement('div');
    titleSection.className = 'card-title-section';

    const title = document.createElement('h3');
    title.className = 'card-title';
    title.textContent = directoryName;

    const info = document.createElement('div');
    info.className = 'card-info';
    info.textContent = 'åŠ è½½ä¸­...';

    titleSection.appendChild(title);
    titleSection.appendChild(info);

    const actions = document.createElement('div');
    actions.className = 'card-actions';

    const collapseBtn = document.createElement('button');
    collapseBtn.className = 'card-collapse-btn';
    collapseBtn.innerHTML = 'âˆ’';
    collapseBtn.title = 'æŠ˜å /å±•å¼€';
    collapseBtn.onclick = () => toggleCardCollapse(card);

    const closeBtn = document.createElement('button');
    closeBtn.className = 'card-close-btn';
    closeBtn.innerHTML = 'Ã—';
    closeBtn.title = 'å…³é—­';
    closeBtn.onclick = (e) => {
      e.stopPropagation();
      closeCard(cardId);
    };

    actions.appendChild(collapseBtn);
    actions.appendChild(closeBtn);

    header.appendChild(titleSection);
    header.appendChild(actions);

    // åˆ›å»ºå¡ç‰‡å†…å®¹åŒºåŸŸ
    const content = document.createElement('div');
    content.className = 'card-content';

    const contentLeft = document.createElement('div');
    contentLeft.className = 'content-left';

    const contentRight = document.createElement('div');
    contentRight.className = 'content-right';

    const contentRightHeader = document.createElement('div');
    contentRightHeader.className = 'content-right-header';
    contentRightHeader.textContent = 'å·²é€‰æ‹©é¡¹ç›®';

    const selectedItemsContainer = document.createElement('div');
    selectedItemsContainer.className = 'selected-items-container';
    selectedItemsContainer.innerHTML = '<div class="empty-selection">å³é”®ç‚¹å‡»é¡¹ç›®æ·»åŠ åˆ°é€‰æ‹©</div>';

    contentRight.appendChild(contentRightHeader);
    contentRight.appendChild(selectedItemsContainer);

    content.appendChild(contentLeft);
    content.appendChild(contentRight);

    card.appendChild(header);
    card.appendChild(content);

    // æ·»åŠ åˆ°DOM
    if (containerID) {
      const container = document.getElementById(containerID);
      if (container) {
        container.appendChild(card);
      } else {
        boardContainer.appendChild(card);
      }
    } else {
      boardContainer.appendChild(card);
    }

    // è®°å½•æ‰“å¼€çš„ç›®å½•
    const path = dirHandle.name;
    openedDirectories.set(path, cardId);
    dirHandleMap.set(path, dirHandle);

    // åˆå§‹åŒ–é€‰ä¸­é¡¹é›†åˆ
    selectedItemsPerCard.set(cardId, new Set());

    // å¡«å……å¡ç‰‡å†…å®¹
    fillCardWithDirectoryContents(contentLeft, info, dirHandle, cardId);

    // æ›´æ–°è°ƒè¯•é¢æ¿
    updateDebugPanel();

    return card;
  }

  /**
   * @function findRootContainer
   * @description æŸ¥æ‰¾å¡ç‰‡æ‰€å±çš„æ ¹å®¹å™¨
   * @param {string} cardId å¡ç‰‡ID
   * @returns {string} æ ¹å®¹å™¨ID
   */
  function findRootContainer(cardId) {
    let currentId = cardId;
    // å‘ä¸Šè¿½æº¯åˆ°æ ¹å¡ç‰‡
    while (directoryRelationships.has(currentId)) {
      currentId = directoryRelationships.get(currentId);
    }

    // è·å–æ ¹å¡ç‰‡çš„çˆ¶å®¹å™¨
    const rootCard = document.getElementById(currentId);
    if (rootCard && rootCard.parentElement) {
      return rootCard.parentElement.id;
    }

    return null;
  }

  /**
   * @function closeCard
   * @description å…³é—­å¡ç‰‡åŠå…¶æ‰€æœ‰å­å¡ç‰‡
   * @param {string} cardId è¦å…³é—­çš„å¡ç‰‡ID
   */
  function closeCard(cardId) {
    // é€’å½’å…³é—­æ‰€æœ‰å­å¡ç‰‡
    const childrenToClose = [];

    directoryRelationships.forEach((parentId, childId) => {
      if (parentId === cardId) {
        childrenToClose.push(childId);
      }
    });

    // å…ˆå…³é—­æ‰€æœ‰å­å¡ç‰‡
    childrenToClose.forEach(childId => closeCard(childId));

    // è·å–å¡ç‰‡DOMå…ƒç´ 
    const card = document.getElementById(cardId);
    if (!card) return;

    // è·å–ç›®å½•è·¯å¾„
    let directoryPath = null;
    openedDirectories.forEach((id, path) => {
      if (id === cardId) {
        directoryPath = path;
      }
    });

    // ç§»é™¤å¡ç‰‡DOMå…ƒç´ 
    card.remove();

    // æ¸…ç†æ•°æ®ç»“æ„
    if (directoryPath) {
      openedDirectories.delete(directoryPath);
      dirHandleMap.delete(directoryPath);
    }

    // ä»çˆ¶å­å…³ç³»ä¸­ç§»é™¤
    directoryRelationships.delete(cardId);

    // ä»æ ¹ç›®å½•é›†åˆä¸­ç§»é™¤
    rootDirectories.delete(cardId);

    // æ¸…ç†é€‰ä¸­é¡¹
    selectedItemsPerCard.delete(cardId);

    // ç§»é™¤è¿æ¥çº¿
    const connectors = document.querySelectorAll(`.connector-for-${cardId}`);
    connectors.forEach(connector => connector.remove());

    // æ›´æ–°è°ƒè¯•é¢æ¿
    updateDebugPanel();
  }

  /**
   * @function clearAllCards
   * @description æ¸…ç©ºæ‰€æœ‰å¡ç‰‡
   */
  function clearAllCards() {
    // å¤åˆ¶æ ¹ç›®å½•IDé›†åˆï¼Œå› ä¸ºåœ¨å¾ªç¯ä¸­ä¼šä¿®æ”¹é›†åˆ
    const rootIds = [...rootDirectories];

    // å…³é—­æ‰€æœ‰æ ¹ç›®å½•å¡ç‰‡
    rootIds.forEach(cardId => closeCard(cardId));

    // é‡ç½®çŠ¶æ€
    openedDirectories.clear();
    directoryRelationships.clear();
    rootDirectories.clear();
    selectedItemsPerCard.clear();
    dirHandleMap.clear();

    // æ¸…ç©ºç¼–è¾‘å™¨
    fileContentEditor.value = '';
    fileContentEditor.disabled = true;
    saveChangesButton.disabled = true;
    currentFileHandle = null;

    // ç§»é™¤ç¼–è¾‘å™¨æ ‡ç­¾
    const existingLabel = document.querySelector('.editor-label');
    if (existingLabel) {
      existingLabel.remove();
    }

    // æ›´æ–°è°ƒè¯•é¢æ¿
    updateDebugPanel();
  }

  /**
   * @function selectItem
   * @description é€‰ä¸­é¡¹ç›®å¹¶æ·»åŠ åˆ°å³ä¾§é¢æ¿
   * @param {string} cardId å¡ç‰‡ID
   * @param {string} itemType é¡¹ç›®ç±»å‹ ('file' æˆ– 'directory')
   * @param {string} itemName é¡¹ç›®åç§°
   */
  function selectItem(cardId, itemType, itemName) {
    // è·å–æˆ–åˆ›å»ºé€‰ä¸­é¡¹é›†åˆ
    if (!selectedItemsPerCard.has(cardId)) {
      selectedItemsPerCard.set(cardId, new Set());
    }

    const items = selectedItemsPerCard.get(cardId);
    const itemId = `${itemType}-${itemName}`;

    // å¦‚æœå·²ç»é€‰ä¸­åˆ™ä¸é‡å¤æ·»åŠ 
    if (items.has(itemId)) {
      showStatusMessage(`é¡¹ç›® ${itemName} å·²ç»åœ¨é€‰ä¸­åˆ—è¡¨ä¸­`);
      return;
    }

    // æ·»åŠ åˆ°é€‰ä¸­é›†åˆ
    items.add(itemId);

    // æ›´æ–°é¢æ¿
    updateSelectedItemsPanel(cardId);

    // æ›´æ–°è°ƒè¯•é¢æ¿
    updateDebugPanel();

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    showStatusMessage(`å·²é€‰ä¸­ ${itemName}`);
  }

  /**
   * @function removeSelectedItem
   * @description ä»é€‰ä¸­é¡¹ä¸­ç§»é™¤
   * @param {string} cardId å¡ç‰‡ID
   * @param {string} itemId é¡¹ç›®ID
   */
  function removeSelectedItem(cardId, itemId) {
    if (!selectedItemsPerCard.has(cardId)) return;

    const items = selectedItemsPerCard.get(cardId);

    // ä»é›†åˆä¸­ç§»é™¤
    items.delete(itemId);

    // æ›´æ–°é¢æ¿
    updateSelectedItemsPanel(cardId);

    // æ›´æ–°è°ƒè¯•é¢æ¿
    updateDebugPanel();

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    const itemName = itemId.split('-').slice(1).join('-');
    showStatusMessage(`å·²ç§»é™¤ ${itemName}`);
  }

  /**
   * @function updateSelectedItemsPanel
   * @description æ›´æ–°å¡ç‰‡å³ä¾§çš„å·²é€‰ä¸­é¡¹é¢æ¿
   * @param {string} cardId å¡ç‰‡ID
   */
  function updateSelectedItemsPanel(cardId) {
    const card = document.getElementById(cardId);
    if (!card) return;

    const selectedItemsContainer = card.querySelector('.selected-items-container');
    if (!selectedItemsContainer) return;

    const items = selectedItemsPerCard.get(cardId);

    if (!items || items.size === 0) {
      selectedItemsContainer.innerHTML = '<div class="empty-selection">å³é”®ç‚¹å‡»é¡¹ç›®æ·»åŠ åˆ°é€‰æ‹©</div>';
      return;
    }

    // æ¸…ç©ºå®¹å™¨
    selectedItemsContainer.innerHTML = '';

    // æ·»åŠ æ‰€æœ‰é€‰ä¸­é¡¹
    for (const itemId of items) {
      const [itemType, ...nameParts] = itemId.split('-');
      const itemName = nameParts.join('-');

      const itemElement = document.createElement('div');
      itemElement.className = 'selected-item';

      const nameElement = document.createElement('div');
      nameElement.className = 'item-name';

      const icon = document.createElement('span');
      icon.className = 'item-icon';
      icon.textContent = itemType === 'file' ? 'ğŸ“„' : 'ğŸ“';

      nameElement.appendChild(icon);
      nameElement.appendChild(document.createTextNode(itemName));

      const removeButton = document.createElement('button');
      removeButton.className = 'remove-item';
      removeButton.textContent = 'Ã—';
      removeButton.onclick = () => removeSelectedItem(cardId, itemId);

      itemElement.appendChild(nameElement);
      itemElement.appendChild(removeButton);

      selectedItemsContainer.appendChild(itemElement);
    }
  }

  /**
   * @function showStatusMessage
   * @description æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
   * @param {string} message æ¶ˆæ¯å†…å®¹
   * @param {boolean} isError æ˜¯å¦ä¸ºé”™è¯¯æ¶ˆæ¯
   */
  function showStatusMessage(message, isError = false) {
    statusMessageElement.textContent = message;
    statusMessageElement.style.display = 'block';

    if (isError) {
      statusMessageElement.style.backgroundColor = '#ffebee';
      statusMessageElement.style.color = '#c62828';
    } else {
      statusMessageElement.style.backgroundColor = '#e3f2fd';
      statusMessageElement.style.color = '#0d47a1';
    }

    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
      statusMessageElement.style.display = 'none';
    }, 3000);
  }

  /**
   * @function fillCardWithDirectoryContents
   * @description å¡«å……å¡ç‰‡å†…å®¹åŒºåŸŸ
   * @param {HTMLElement} contentLeft å·¦ä¾§å†…å®¹å…ƒç´ 
   * @param {HTMLElement} cardInfo å¡ç‰‡ä¿¡æ¯å…ƒç´ 
   * @param {FileSystemDirectoryHandle} dirHandle ç›®å½•å¥æŸ„
   * @param {string} cardId å¡ç‰‡ID
   * @async
   */
  async function fillCardWithDirectoryContents(contentLeft, cardInfo, dirHandle, cardId) {
    try {
      // æ¸…ç©ºå¡ç‰‡å†…å®¹
      contentLeft.innerHTML = '';
      let fileCount = 0;
      let dirCount = 0;

      // éå†ç›®å½•å†…å®¹
      for await (const entry of dirHandle.values()) {
        const entryElement = document.createElement('div');
        if (entry.kind === 'directory') {
          dirCount++;
          entryElement.className = 'directory-item';
          entryElement.innerHTML = `<span class="item-icon">ğŸ“</span> ${entry.name}`;

          // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆå·¦é”®ï¼‰
          entryElement.addEventListener('click', () => handleDirectoryClick(entry, cardId));

          // æ·»åŠ å³é”®äº‹ä»¶
          entryElement.addEventListener('contextmenu', (event) => {
            event.preventDefault(); // é˜»æ­¢é»˜è®¤å³é”®èœå•
            selectItem(cardId, 'directory', entry.name);
          });
        } else {
          fileCount++;
          entryElement.className = 'file-item';
          entryElement.innerHTML = `<span class="item-icon">ğŸ“„</span> ${entry.name}`;

          // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆå·¦é”®ï¼‰
          entryElement.addEventListener('click', () => handleFileReadAsText(entry));

          // æ·»åŠ å³é”®äº‹ä»¶
          entryElement.addEventListener('contextmenu', (event) => {
            event.preventDefault(); // é˜»æ­¢é»˜è®¤å³é”®èœå•
            selectItem(cardId, 'file', entry.name);
          });
        }
        contentLeft.appendChild(entryElement);
      }

      // æ›´æ–°å¡ç‰‡ä¿¡æ¯
      cardInfo.textContent = `${dirCount} ä¸ªç›®å½•, ${fileCount} ä¸ªæ–‡ä»¶`;
    } catch (error) {
      contentLeft.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      cardInfo.textContent = 'åŠ è½½å¤±è´¥';
      console.error('[DEBUG] ç›®å½•å†…å®¹åŠ è½½å¤±è´¥', error);
    }
  }

  /**
   * @function handleDirectorySelectionAndDisplay
   * @description å¤„ç†ç”¨æˆ·é€‰æ‹©ç›®å½•å¹¶å±•ç¤ºå…¶å†…å®¹
   * @async
   */
  async function handleDirectorySelectionAndDisplay() {
    try {
      // è¯·æ±‚è¯»å†™æƒé™ä»¥æ”¯æŒç¼–è¾‘æ“ä½œ
      const dirHandle = await window.showDirectoryPicker({
        mode: 'readwrite' // éœ€è¦è¯»å†™æƒé™
      });

      // æ£€æŸ¥ç›®å½•æ˜¯å¦å·²ç»æ‰“å¼€
      if (await isDirectoryAlreadyOpen(dirHandle)) {
        const existingCardId = getExistingCardId(dirHandle);
        if (existingCardId) {
          const card = document.getElementById(existingCardId);
          if (card) {
            // å·²æ‰“å¼€ç›®å½•ï¼Œæ»šåŠ¨åˆ°è¯¥å¡ç‰‡
            card.scrollIntoView({ behavior: 'smooth' });
            showStatusMessage(`ç›®å½• ${dirHandle.name} å·²ç»æ‰“å¼€`);
            return;
          }
        }
      }

      // åˆ›å»ºæ–°çš„æ ¹å®¹å™¨
      const containerId = createRootContainer();

      // åˆ›å»ºæ ¹ç›®å½•å¡ç‰‡
      const rootCard = createDirectoryCard(dirHandle.name, dirHandle, null, containerId);

      // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
      showStatusMessage(`æˆåŠŸæ·»åŠ ç›®å½•: ${dirHandle.name}`);
    } catch (error) {
      console.error('[DEBUG] ç›®å½•é€‰æ‹©å¤±è´¥', error);
      showStatusMessage(`é€‰æ‹©ç›®å½•å¤±è´¥: ${error.message}`, true);
    }
  }

  /**
   * @function createConnectorLines
   * @description åˆ›å»ºè¿æ¥çˆ¶å¡ç‰‡å’Œå­å¡ç‰‡çš„è¿æ¥çº¿
   * @param {HTMLElement} parentCard çˆ¶å¡ç‰‡å…ƒç´ 
   * @param {HTMLElement} childCard å­å¡ç‰‡å…ƒç´ 
   */
  function createConnectorLines(parentCard, childCard) {
    if (!parentCard || !childCard) return;

    const parentRect = parentCard.getBoundingClientRect();
    const childRect = childCard.getBoundingClientRect();

    const boardRect = boardContainer.getBoundingClientRect();

    // è®¡ç®—ç›¸å¯¹äºboard-containerçš„ä½ç½®
    const parentLeft = parentRect.left - boardRect.left + boardContainer.scrollLeft;
    const parentTop = parentRect.top - boardRect.top + boardContainer.scrollTop;
    const childLeft = childRect.left - boardRect.left + boardContainer.scrollLeft;
    const childTop = childRect.top - boardRect.top + boardContainer.scrollTop;

    // åˆ›å»ºè¿æ¥çº¿å®¹å™¨
    const connector = document.createElement('div');
    connector.className = `card-connector connector-for-${childCard.id}`;

    // è®¡ç®—è¿æ¥çº¿ä½ç½®
    const startX = parentLeft + parentRect.width;
    const startY = parentTop + parentRect.height / 2;
    const endX = childLeft;
    const endY = childTop + childRect.height / 2;

    // æ°´å¹³çº¿
    const horizontalLine = document.createElement('div');
    horizontalLine.className = 'connector-horizontal';
    horizontalLine.style.position = 'absolute';
    horizontalLine.style.left = `${startX}px`;
    horizontalLine.style.top = `${startY}px`;
    horizontalLine.style.width = `${(endX - startX) / 2}px`;

    // å‚ç›´çº¿
    const verticalLine = document.createElement('div');
    verticalLine.className = 'connector-vertical';
    verticalLine.style.position = 'absolute';
    verticalLine.style.left = `${startX + (endX - startX) / 2}px`;
    verticalLine.style.top = `${Math.min(startY, endY)}px`;
    verticalLine.style.height = `${Math.abs(endY - startY)}px`;

    // æ°´å¹³çº¿2
    const horizontalLine2 = document.createElement('div');
    horizontalLine2.className = 'connector-horizontal';
    horizontalLine2.style.position = 'absolute';
    horizontalLine2.style.left = `${startX + (endX - startX) / 2}px`;
    horizontalLine2.style.top = `${endY}px`;
    horizontalLine2.style.width = `${(endX - startX) / 2}px`;

    // æ·»åŠ èŠ‚ç‚¹
    const startNode = document.createElement('div');
    startNode.className = 'connector-node';
    startNode.style.left = `${startX - 4}px`;
    startNode.style.top = `${startY - 4}px`;

    const endNode = document.createElement('div');
    endNode.className = 'connector-node';
    endNode.style.left = `${endX - 4}px`;
    endNode.style.top = `${endY - 4}px`;

    // æ·»åŠ åˆ°DOM
    boardContainer.appendChild(horizontalLine);
    boardContainer.appendChild(verticalLine);
    boardContainer.appendChild(horizontalLine2);
    boardContainer.appendChild(startNode);
    boardContainer.appendChild(endNode);
  }

  /**
   * @function toggleCardCollapse
   * @description åˆ‡æ¢å¡ç‰‡çš„æ”¶èµ·/å±•å¼€çŠ¶æ€
   * @param {HTMLElement} card è¦åˆ‡æ¢çš„å¡ç‰‡å…ƒç´ 
   */
  function toggleCardCollapse(card) {
    if (card.classList.contains('card-collapsed')) {
      // å±•å¼€å¡ç‰‡
      card.classList.remove('card-collapsed');
      card.querySelector('.card-collapse-btn').innerHTML = 'âˆ’';
    } else {
      // æ”¶èµ·å¡ç‰‡
      card.classList.add('card-collapsed');
      card.querySelector('.card-collapse-btn').innerHTML = '+';
    }

    // æ›´æ–°è¿æ¥çº¿
    setTimeout(updateConnectors, 300); // ç­‰å¾…è¿‡æ¸¡åŠ¨ç”»å®Œæˆ
  }

  /**
   * @function handleDirectoryClick
   * @description å¤„ç†ç›®å½•ç‚¹å‡»ï¼Œæ‰“å¼€å­ç›®å½•
   * @param {FileSystemDirectoryHandle} dirHandle ç›®å½•å¥æŸ„
   * @param {string} parentCardId çˆ¶å¡ç‰‡ID
   * @async
   */
  async function handleDirectoryClick(dirHandle, parentCardId) {
    try {
      // æ£€æŸ¥ç›®å½•æ˜¯å¦å·²ç»æ‰“å¼€
      if (await isDirectoryAlreadyOpen(dirHandle)) {
        const existingCardId = getExistingCardId(dirHandle);
        if (existingCardId) {
          const card = document.getElementById(existingCardId);
          if (card) {
            // å·²æ‰“å¼€ç›®å½•ï¼Œæ»šåŠ¨åˆ°è¯¥å¡ç‰‡
            card.scrollIntoView({ behavior: 'smooth' });
            showStatusMessage(`ç›®å½• ${dirHandle.name} å·²ç»æ‰“å¼€`);
            return;
          }
        }
      }

      // è·å–çˆ¶å¡ç‰‡å’Œå®¹å™¨
      const parentCard = document.getElementById(parentCardId);
      if (!parentCard) {
        throw new Error('æ‰¾ä¸åˆ°çˆ¶å¡ç‰‡');
      }

      const containerID = findRootContainer(parentCardId);

      // åˆ›å»ºæ–°çš„ç›®å½•å¡ç‰‡
      const directoryCard = createDirectoryCard(dirHandle.name, dirHandle, parentCardId, containerID);

      // åˆ›å»ºè¿æ¥çº¿
      setTimeout(() => {
        createConnectorLines(parentCard, directoryCard);
      }, 10);

      // æ»šåŠ¨åˆ°æ–°å¡ç‰‡ä½ç½®
      directoryCard.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
      console.error('[DEBUG] æ‰“å¼€å­ç›®å½•å¤±è´¥', error);
      showStatusMessage(`æ‰“å¼€ç›®å½•å¤±è´¥: ${error.message}`, true);
    }
  }

  /**
   * @function handleFileReadAsText
   * @description å°†æ–‡ä»¶ä½œä¸ºæ–‡æœ¬è¯»å–å¹¶æ˜¾ç¤º
   * @param {FileSystemFileHandle} fileHandle æ–‡ä»¶å¥æŸ„
   * @async
   */
  async function handleFileReadAsText(fileHandle) {
    try {
      const file = await fileHandle.getFile();
      const textContent = await file.text();
      fileContentEditor.value = textContent;
      fileContentEditor.disabled = false;
      saveChangesButton.disabled = false;
      currentFileHandle = fileHandle;

      // æ·»åŠ å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–‡ä»¶ä¿¡æ¯
      const editorLabel = document.createElement('div');
      editorLabel.textContent = `æ­£åœ¨ç¼–è¾‘: ${fileHandle.name}`;

      // å¦‚æœå·²ç»æœ‰æ ‡ç­¾ï¼Œåˆ™æ›¿æ¢å®ƒ
      const existingLabel = document.querySelector('.editor-label');
      if (existingLabel) {
        existingLabel.remove();
      }

      editorLabel.className = 'editor-label';
      document.querySelector('.editor-container').insertBefore(editorLabel, fileContentEditor);

      // æ»šåŠ¨åˆ°ç¼–è¾‘å™¨ä½ç½®
      fileContentEditor.scrollIntoView({ behavior: 'smooth' });

      // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
      showStatusMessage(`å·²åŠ è½½æ–‡ä»¶: ${fileHandle.name}`);

      // æ›´æ–°è°ƒè¯•é¢æ¿
      updateDebugPanel();
    } catch (error) {
      console.error('[DEBUG] æ–‡ä»¶è¯»å–å¤±è´¥', error);
      showStatusMessage(`è¯»å–æ–‡ä»¶å¤±è´¥: ${error.message}`, true);
    }
  }

  /**
   * @function updateConnectors
   * @description æ›´æ–°æ‰€æœ‰è¿æ¥çº¿ä½ç½®
   */
  function updateConnectors() {
    // ç§»é™¤æ‰€æœ‰è¿æ¥çº¿
    const connectors = document.querySelectorAll('.card-connector, .connector-node');
    connectors.forEach(connector => connector.remove());

    // é‡æ–°ç»˜åˆ¶æ‰€æœ‰è¿æ¥çº¿
    directoryRelationships.forEach((parentId, childId) => {
      const parentCard = document.getElementById(parentId);
      const childCard = document.getElementById(childId);
      if (parentCard && childCard) {
        createConnectorLines(parentCard, childCard);
      }
    });
  }

  // çª—å£å¤§å°æ”¹å˜æ—¶æ›´æ–°è¿æ¥çº¿
  window.addEventListener('resize', updateConnectors);

  /**
   * @function handleSaveFileChanges
   * @description ä¿å­˜å¯¹æ–‡ä»¶çš„ä¿®æ”¹
   * @async
   */
  async function handleSaveFileChanges() {
    if (!currentFileHandle) {
      showStatusMessage('æ²¡æœ‰æ‰“å¼€çš„æ–‡ä»¶', true);
      return;
    }

    try {
      const writable = await currentFileHandle.createWritable();
      await writable.write(fileContentEditor.value);
      await writable.close();
      showStatusMessage(`æ–‡ä»¶ ${currentFileHandle.name} å·²ä¿å­˜`);
    } catch (error) {
      console.error('[DEBUG] ä¿å­˜æ–‡ä»¶å¤±è´¥', error);
      showStatusMessage(`ä¿å­˜æ–‡ä»¶å¤±è´¥: ${error.message}`, true);
    }
  }

  /**
   * @function addCollapseAllButton
   * @description æ·»åŠ æŠ˜å /å±•å¼€æ‰€æœ‰å¡ç‰‡æŒ‰é’®
   */
  function addCollapseAllButton() {
    const collapseAllButton = document.createElement('button');
    collapseAllButton.textContent = 'æŠ˜å /å±•å¼€æ‰€æœ‰';
    collapseAllButton.id = 'collapseAllButton';

    // æ™ºèƒ½åˆ‡æ¢æ‰€æœ‰å¡ç‰‡çŠ¶æ€
    function toggleAllCards() {
      const allCards = document.querySelectorAll('.directory-card');
      if (allCards.length === 0) return;

      let anyExpanded = false;
      // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å¡ç‰‡å¤„äºå±•å¼€çŠ¶æ€
      allCards.forEach(card => {
        if (!card.classList.contains('card-collapsed')) {
          anyExpanded = true;
        }
      });

      // å¦‚æœæœ‰ä»»ä½•å¡ç‰‡å±•å¼€ï¼Œåˆ™æ”¶èµ·æ‰€æœ‰å¡ç‰‡
      if (anyExpanded) {
        allCards.forEach(card => {
          if (!card.classList.contains('card-collapsed')) {
            card.classList.add('card-collapsed');
            card.querySelector('.card-collapse-btn').innerHTML = '+';
          }
        });
      }
      // å¦‚æœæ‰€æœ‰å¡ç‰‡éƒ½å·²æ”¶èµ·ï¼Œåˆ™å±•å¼€æ‰€æœ‰å¡ç‰‡
      else {
        allCards.forEach(card => {
          card.classList.remove('card-collapsed');
          card.querySelector('.card-collapse-btn').innerHTML = 'âˆ’';
        });
      }

      // æ›´æ–°è¿æ¥çº¿
      setTimeout(updateConnectors, 300);
    }

    collapseAllButton.addEventListener('click', toggleAllCards);

    // æ·»åŠ åˆ°æ§åˆ¶åŒºåŸŸ
    document.querySelector('.controls').appendChild(collapseAllButton);
  }

  // åˆå§‹åŒ–è°ƒè¯•é¢æ¿
  updateDebugPanel();
</script>
</body>
</html>