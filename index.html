<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ–‡ä»¶ç³»ç»Ÿè®¿é—® API - å¤šç›®å½•ç”µè·¯æ¿å¼æµè§ˆ</title>
  <style>
    /* åŸºæœ¬æ ·å¼ */
    body {
      font-family: Arial, sans-serif;
      padding: 0;
      margin: 0;
      background-color: #f5f5f5;
      display: flex;
      min-height: 100vh;
    }
    
    /* å·¦ä¾§è°ƒè¯•é¢æ¿ */
    .debug-panel {
      width: 280px;
      background-color: #263238;
      color: #fff;
      padding: 15px;
      box-sizing: border-box;
      overflow-y: auto;
      height: 100vh;
      position: sticky;
      top: 0;
    }
    
    .debug-panel h2 {
      font-size: 18px;
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #455A64;
    }
    
    .debug-section {
      margin-bottom: 20px;
    }
    
    .debug-section h3 {
      font-size: 14px;
      color: #81D4FA;
      margin-top: 0;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .debug-content {
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      background-color: #1E272C;
      padding: 10px;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      color: #A5D6A7;
    }
    
    .debug-content.json {
      color: #FFD54F;
    }
    
    .debug-count {
      background-color: #455A64;
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 11px;
      margin-left: 5px;
    }
    
    /* ä¸»å†…å®¹åŒºåŸŸ */
    .main-content {
      flex-grow: 1;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      height: 100vh;
    }
    
    /* æ§åˆ¶åŒºåŸŸ */
    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    button.danger {
      background-color: #f44336;
    }
    
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    /* å¸ƒå±€å®¹å™¨ - ç”µè·¯æ¿é£æ ¼ */
    .board-container {
      position: relative;
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      margin-bottom: 20px;
      padding: 20px;
      background-color: #f0f0f0;
      border-radius: 10px;
      border: 1px solid #ddd;
      min-height: 400px;
    }
    
    /* æ ¹ç›®å½•åŒºåŸŸ */
    .root-directory-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative;
    }
    
    /* ç›®å½•å¡ç‰‡æ ·å¼ */
    .directory-card {
      position: relative;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      width: 600px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      background-color: white;
      margin-left: 30px;
      z-index: 2;
      transition: box-shadow 0.3s;
    }
    
    /* æ”¶èµ·çŠ¶æ€çš„å¡ç‰‡æ ·å¼ */
    .directory-card.card-collapsed {
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    /* æ ¹ç›®å½•å¡ç‰‡ */
    .directory-card.root {
      margin-left: 0;
    }
    
    /* å¡ç‰‡è¿æ¥çº¿ */
    .card-connector {
      position: absolute;
      border: 2px solid #4285f4;
      z-index: 1;
    }
    
    .connector-horizontal {
      height: 2px;
      background-color: #4285f4;
    }
    
    .connector-vertical {
      width: 2px;
      background-color: #4285f4;
    }
    
    /* å¡ç‰‡èŠ‚ç‚¹ç‚¹ */
    .connector-node {
      position: absolute;
      width: 8px;
      height: 8px;
      background-color: #4285f4;
      border-radius: 50%;
      z-index: 1;
    }
    
    .card-header {
      background-color: #4285f4;
      padding: 12px;
      border-bottom: 1px solid #ddd;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .root .card-header {
      background-color: #FF5722;
    }
    
    .card-title-section {
      flex-grow: 1;
    }
    
    .card-title {
      margin: 0;
      font-size: 16px;
      font-weight: bold;
    }
    
    .card-info {
      font-size: 12px;
      margin-top: 5px;
      color: rgba(255, 255, 255, 0.8);
    }
    
    /* å¡ç‰‡æ“ä½œæŒ‰é’® */
    .card-actions {
      display: flex;
      gap: 5px;
    }
    
    .card-collapse-btn, .card-close-btn {
      background-color: transparent;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 0;
    }
    
    .card-collapse-btn:hover, .card-close-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    /* åˆ†æ å¸ƒå±€ */
    .card-content {
      display: flex;
      height: 300px;
    }
    
    .content-left {
      flex: 1;
      border-right: 1px solid #eee;
      overflow-y: auto;
    }
    
    .content-right {
      flex: 1;
      overflow-y: auto;
      background-color: #f9f9f9;
    }
    
    .content-right-header {
      padding: 10px;
      background-color: #E3F2FD;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
      color: #0D47A1;
    }
    
    /* æ–‡ä»¶é¡¹æ ·å¼ */
    .file-item, .directory-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    
    .file-item:hover, .directory-item:hover {
      background-color: #f0f0f0;
    }
    
    .directory-item {
      color: #4285f4;
    }
    
    .item-icon {
      margin-right: 8px;
      font-size: 16px;
    }
    
    /* é€‰ä¸­é¡¹æ ·å¼ */
    .selected-item {
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
      background-color: #E8F5E9;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .selected-item .item-name {
      display: flex;
      align-items: center;
    }
    
    .remove-item {
      background-color: transparent;
      color: #f44336;
      border: none;
      cursor: pointer;
      padding: 0;
      font-size: 16px;
      font-weight: bold;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .remove-item:hover {
      background-color: rgba(244, 67, 54, 0.1);
    }
    
    .empty-selection {
      padding: 20px;
      color: #757575;
      text-align: center;
      font-style: italic;
    }
    
    /* æ–‡ä»¶ç¼–è¾‘åŒºåŸŸ */
    .editor-container {
      margin-top: 20px;
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .editor-label {
      margin-bottom: 10px;
      font-weight: bold;
      color: #4285f4;
    }
    
    textarea {
      width: 100%;
      height: 300px;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
    }
    
    /* çŠ¶æ€æ¶ˆæ¯ */
    .status-message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background-color: #e3f2fd;
      color: #0d47a1;
    }
    
    /* å³é”®èœå• */
    .context-menu {
      position: absolute;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      padding: 5px 0;
      z-index: 1000;
    }
    
    .context-menu-item {
      padding: 8px 12px;
      cursor: pointer;
    }
    
    .context-menu-item:hover {
      background-color: #f0f0f0;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1200px) {
      body {
        flex-direction: column;
      }
      
      .debug-panel {
        width: 100%;
        height: auto;
        max-height: 300px;
      }
      
      .directory-card {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- å·¦ä¾§è°ƒè¯•é¢æ¿ -->
  <div class="debug-panel">
    <h2>åŸå§‹æ•°æ®ç»“æ„</h2>
    
    <div class="debug-section">
      <h3>openedDirectories <span class="debug-count" id="openedDirCount">0</span></h3>
      <div class="debug-content json" id="openedDirectoriesDebug"></div>
    </div>
    
    <div class="debug-section">
      <h3>directoryRelationships <span class="debug-count" id="relationshipsCount">0</span></h3>
      <div class="debug-content json" id="relationshipsDebug"></div>
    </div>
    
    <div class="debug-section">
      <h3>rootDirectories <span class="debug-count" id="rootDirCount">0</span></h3>
      <div class="debug-content json" id="rootDirectoriesDebug"></div>
    </div>
    
    <div class="debug-section">
      <h3>selectedItems <span class="debug-count" id="selectedItemsCount">0</span></h3>
      <div class="debug-content json" id="selectedItemsDebug"></div>
    </div>
    
    <div class="debug-section">
      <h3>dirHandleMap <span class="debug-count" id="dirHandleMapCount">0</span></h3>
      <div class="debug-content json" id="dirHandleMapDebug"></div>
    </div>
    
    <div class="debug-section">
      <h3>å…¨å±€å˜é‡</h3>
      <div class="debug-content" id="globalVarsDebug"></div>
    </div>
  </div>
  
  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <div class="main-content">
    <div class="controls">
      <button id="addDirectoryButton">æ·»åŠ ç›®å½•</button>
      <button id="clearAllButton" class="danger">æ¸…ç©ºæ‰€æœ‰</button>
      <button id="saveChangesButton" disabled>ä¿å­˜ä¿®æ”¹</button>
    </div>
    
    <div id="boardContainer" class="board-container">
      <!-- æ ¹ç›®å½•å®¹å™¨å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
    </div>
    
    <div class="editor-container">
      <textarea id="fileContentEditor" placeholder="é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ä»¥æŸ¥çœ‹å’Œç¼–è¾‘å…¶å†…å®¹" disabled></textarea>
    </div>
  </div>

  <script>
    // è·å– DOM å…ƒç´ 
    const addDirectoryButton = document.getElementById('addDirectoryButton');
    const clearAllButton = document.getElementById('clearAllButton');
    const saveChangesButton = document.getElementById('saveChangesButton');
    const boardContainer = document.getElementById('boardContainer');
    const fileContentEditor = document.getElementById('fileContentEditor');
    
    // è°ƒè¯•é¢æ¿å…ƒç´ 
    const openedDirectoriesDebug = document.getElementById('openedDirectoriesDebug');
    const relationshipsDebug = document.getElementById('relationshipsDebug');
    const rootDirectoriesDebug = document.getElementById('rootDirectoriesDebug');
    const selectedItemsDebug = document.getElementById('selectedItemsDebug');
    const dirHandleMapDebug = document.getElementById('dirHandleMapDebug');
    const globalVarsDebug = document.getElementById('globalVarsDebug');
    const openedDirCount = document.getElementById('openedDirCount');
    const relationshipsCount = document.getElementById('relationshipsCount');
    const rootDirCount = document.getElementById('rootDirCount');
    const selectedItemsCount = document.getElementById('selectedItemsCount');
    const dirHandleMapCount = document.getElementById('dirHandleMapCount');

    // å…¨å±€å˜é‡ï¼Œç”¨äºä¿å­˜å½“å‰ç¼–è¾‘çš„æ–‡ä»¶å¥æŸ„
    let currentFileHandle = null;
    
    // è®°å½•å·²æ‰“å¼€çš„ç›®å½•è·¯å¾„
    const openedDirectories = new Map();
    
    // è®°å½•ç›®å½•å¡ç‰‡çš„å±‚çº§å…³ç³»
    const directoryRelationships = new Map();
    
    // è®°å½•æ ¹ç›®å½•
    const rootDirectories = new Set();
    
    // è®°å½•æ¯ä¸ªå¡ç‰‡ä¸­é€‰ä¸­çš„é¡¹ç›®
    const selectedItemsPerCard = new Map();
    
    // è®°å½•ç›®å½•å¥æŸ„ï¼Œç”¨äºé˜²æ­¢é‡å¤æ‰“å¼€
    const dirHandleMap = new Map();
    
    // ä¸ºæ¯ä¸ªå¡ç‰‡ç”Ÿæˆå”¯ä¸€ID
    let cardIdCounter = 0;
    
    // ä¸ºæ¯ä¸ªæ ¹ç›®å½•å®¹å™¨ç”Ÿæˆå”¯ä¸€ID
    let rootContainerIdCounter = 0;
    
    /**
     * @function updateDebugPanel
     * @description æ›´æ–°è°ƒè¯•é¢æ¿çš„å†…å®¹ï¼Œæ˜¾ç¤ºåŸå§‹æ•°æ®ç»“æ„
     */
    function updateDebugPanel() {
      // è½¬æ¢ Map å’Œ Set ä¸ºå¯¹è±¡å’Œæ•°ç»„ä»¥ä¾¿æ›´å¥½åœ°å±•ç¤º
      // openedDirectories Map
      const openedDirsObj = {};
      openedDirectories.forEach((dirHandle, cardId) => {
        openedDirsObj[cardId] = {
          name: dirHandle.name,
          kind: dirHandle.kind,
          isRoot: rootDirectories.has(cardId)
        };
      });
      openedDirectoriesDebug.textContent = JSON.stringify(openedDirsObj, null, 2);
      openedDirCount.textContent = openedDirectories.size;
      
      // directoryRelationships Map
      const relationshipsObj = {};
      directoryRelationships.forEach((parentId, childId) => {
        relationshipsObj[childId] = parentId;
      });
      relationshipsDebug.textContent = JSON.stringify(relationshipsObj, null, 2);
      relationshipsCount.textContent = directoryRelationships.size;
      
      // rootDirectories Set
      rootDirectoriesDebug.textContent = JSON.stringify([...rootDirectories], null, 2);
      rootDirCount.textContent = rootDirectories.size;
      
      // selectedItemsPerCard Map
      const selectedItemsObj = {};
      selectedItemsPerCard.forEach((items, cardId) => {
        selectedItemsObj[cardId] = [...items].map(item => {
          const [type, name] = item.split('::');
          return { type, name };
        });
      });
      selectedItemsDebug.textContent = JSON.stringify(selectedItemsObj, null, 2);
      const totalItems = [...selectedItemsPerCard.values()].reduce((acc, set) => acc + set.size, 0);
      selectedItemsCount.textContent = totalItems;
      
      // dirHandleMap
      const dirHandleObj = {};
      dirHandleMap.forEach((cardId, path) => {
        dirHandleObj[path] = cardId;
      });
      dirHandleMapDebug.textContent = JSON.stringify(dirHandleObj, null, 2);
      dirHandleMapCount.textContent = dirHandleMap.size;
      
      // å…¨å±€å˜é‡
      const globalVars = {
        cardIdCounter,
        rootContainerIdCounter,
        hasCurrentFile: currentFileHandle !== null
      };
      globalVarsDebug.textContent = JSON.stringify(globalVars, null, 2);
    }
    
    /**
     * @function isDirectoryAlreadyOpen
     * @description æ£€æŸ¥ç›®å½•æ˜¯å¦å·²ç»æ‰“å¼€
     * @param {FileSystemDirectoryHandle} dirHandle ç›®å½•å¥æŸ„
     * @returns {boolean} ç›®å½•æ˜¯å¦å·²ç»æ‰“å¼€
     */
    async function isDirectoryAlreadyOpen(dirHandle) {
      // å°è¯•è·å–å”¯ä¸€æ ‡è¯†ç¬¦
      try {
        // ä½¿ç”¨ç›®å½•åç§°ä½œä¸ºç®€å•çš„æ ‡è¯†ç¬¦
        // åœ¨å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„é€»è¾‘æ¥ç¡®å®šå”¯ä¸€æ€§
        const path = dirHandle.name;
        return dirHandleMap.has(path);
      } catch (error) {
        console.error('æ£€æŸ¥ç›®å½•æ˜¯å¦å·²æ‰“å¼€æ—¶å‡ºé”™', error);
        return false;
      }
    }
    
    /**
     * @function getExistingCardId
     * @description è·å–å·²æ‰“å¼€ç›®å½•çš„å¡ç‰‡ID
     * @param {FileSystemDirectoryHandle} dirHandle ç›®å½•å¥æŸ„
     * @returns {string|null} å¡ç‰‡IDï¼Œå¦‚æœæœªæ‰“å¼€åˆ™è¿”å›null
     */
    function getExistingCardId(dirHandle) {
      const path = dirHandle.name;
      return dirHandleMap.get(path) || null;
    }

    /**
     * @function createRootContainer
     * @description åˆ›å»ºæ ¹ç›®å½•å®¹å™¨
     * @returns {string} å®¹å™¨ID
     */
    function createRootContainer() {
      const containerId = `root_container_${rootContainerIdCounter++}`;
      
      const container = document.createElement('div');
      container.className = 'root-directory-container';
      container.id = containerId;
      
      boardContainer.appendChild(container);
      
      return containerId;
    }

    /**
     * @function createDirectoryCard
     * @description åˆ›å»ºç›®å½•å¡ç‰‡
     * @param {string} directoryName ç›®å½•åç§°
     * @param {FileSystemDirectoryHandle} dirHandle ç›®å½•å¥æŸ„
     * @param {string|null} parentCardId çˆ¶å¡ç‰‡ID
     * @param {string|null} containerID å®¹å™¨ID
     * @returns {HTMLElement} åˆ›å»ºçš„å¡ç‰‡å…ƒç´ 
     */
    function createDirectoryCard(directoryName, dirHandle, parentCardId = null, containerID = null) {
      // ç”Ÿæˆå”¯ä¸€å¡ç‰‡ID
      const cardId = `card_${cardIdCounter++}`;
      
      const card = document.createElement('div');
      card.className = parentCardId ? 'directory-card' : 'directory-card root';
      card.id = cardId;
      card.dataset.name = directoryName;
      
      if (!parentCardId) {
        rootDirectories.add(cardId);
      }
      
      // åˆ›å»ºå¡ç‰‡å¤´éƒ¨
      const cardHeader = document.createElement('div');
      cardHeader.className = 'card-header';
      
      // æ ‡é¢˜éƒ¨åˆ†ï¼ˆå·¦ä¾§ï¼‰
      const titleSection = document.createElement('div');
      titleSection.className = 'card-title-section';
      
      // æ”¶èµ·/å±•å¼€æŒ‡ç¤ºå™¨
      const collapseIndicator = document.createElement('span');
      collapseIndicator.className = 'collapse-indicator';
      collapseIndicator.textContent = '';
      
      const cardTitle = document.createElement('h3');
      cardTitle.className = 'card-title';
      cardTitle.textContent = directoryName;
      
      const cardInfo = document.createElement('div');
      cardInfo.className = 'card-info';
      cardInfo.textContent = 'ç›®å½•ä¿¡æ¯åŠ è½½ä¸­...';
      
      titleSection.appendChild(collapseIndicator);
      titleSection.appendChild(cardTitle);
      titleSection.appendChild(cardInfo);
      
      // æŒ‰é’®éƒ¨åˆ†ï¼ˆå³ä¾§ï¼‰
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'card-actions';
      
      // æ”¶èµ·/å±•å¼€æŒ‰é’®
      const collapseBtn = document.createElement('button');
      collapseBtn.className = 'card-collapse-btn';
      collapseBtn.innerHTML = 'â–¼';
      collapseBtn.title = 'æ”¶èµ·';
      collapseBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        toggleCardCollapse(card);
        // æ›´æ–°æŒ‰é’®æ–‡æœ¬å’Œæ ‡é¢˜
        if (card.classList.contains('card-collapsed')) {
          collapseBtn.innerHTML = 'â–¶';
          collapseBtn.title = 'å±•å¼€';
        } else {
          collapseBtn.innerHTML = 'â–¼';
          collapseBtn.title = 'æ”¶èµ·';
        }
      });
      
      // å…³é—­æŒ‰é’®
      const closeBtn = document.createElement('button');
      closeBtn.className = 'card-close-btn';
      closeBtn.innerHTML = 'âœ•';
      closeBtn.title = 'å…³é—­å¡ç‰‡';
      closeBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        closeCard(cardId);
      });
      
      actionsDiv.appendChild(collapseBtn);
      actionsDiv.appendChild(closeBtn);
      
      cardHeader.appendChild(titleSection);
      cardHeader.appendChild(actionsDiv);
      
      // æ·»åŠ æ”¶èµ·/å±•å¼€åŠŸèƒ½
      cardHeader.addEventListener('click', (event) => {
        // ç¡®ä¿ä¸æ˜¯ç‚¹å‡»äº†å…³é—­æŒ‰é’®
        if (!event.target.closest('.card-close-btn')) {
          toggleCardCollapse(card);
        }
      });
      
      // åˆ›å»ºå¡ç‰‡å†…å®¹åŒºåŸŸ - å·¦å³åˆ†æ 
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // å·¦ä¾§å†…å®¹åŒºåŸŸ
      const contentLeft = document.createElement('div');
      contentLeft.className = 'content-left';
      
      // å³ä¾§é€‰ä¸­åŒºåŸŸ
      const contentRight = document.createElement('div');
      contentRight.className = 'content-right';
      
      // å³ä¾§æ ‡é¢˜
      const contentRightHeader = document.createElement('div');
      contentRightHeader.className = 'content-right-header';
      contentRightHeader.textContent = 'å·²é€‰ä¸­é¡¹ç›®';
      contentRight.appendChild(contentRightHeader);
      
      // åˆå§‹åŒ–ç©ºé€‰æ‹©æç¤º
      const emptySelection = document.createElement('div');
      emptySelection.className = 'empty-selection';
      emptySelection.textContent = 'å³é”®ç‚¹å‡»å·¦ä¾§é¡¹ç›®æ¥é€‰æ‹©';
      contentRight.appendChild(emptySelection);
      
      // ç»„è£…å¡ç‰‡
      cardContent.appendChild(contentLeft);
      cardContent.appendChild(contentRight);
      card.appendChild(cardHeader);
      card.appendChild(cardContent);
      
      // åˆå§‹åŒ–é€‰ä¸­é¡¹é›†åˆ
      selectedItemsPerCard.set(cardId, new Set());
      
      // è®°å½•å±‚çº§å…³ç³»
      if (parentCardId) {
        directoryRelationships.set(cardId, parentCardId);
      }
      
      // æ·»åŠ åˆ°å®¹å™¨
      const targetContainer = containerID 
        ? document.getElementById(containerID) 
        : parentCardId ? document.getElementById(findRootContainer(parentCardId)) : null;
      
      if (targetContainer) {
        targetContainer.appendChild(card);
      } else {
        console.error('æ‰¾ä¸åˆ°ç›®æ ‡å®¹å™¨', containerID, parentCardId);
      }
      
      // å¡«å……å¡ç‰‡å†…å®¹
      fillCardWithDirectoryContents(contentLeft, cardInfo, dirHandle, cardId);
      
      // è®°å½•å·²æ‰“å¼€çš„ç›®å½•
      openedDirectories.set(cardId, dirHandle);
      
      // è®°å½•ç›®å½•å¥æŸ„æ˜ å°„ï¼Œé˜²æ­¢é‡å¤æ‰“å¼€
      dirHandleMap.set(dirHandle.name, cardId);
      
      // æ›´æ–°è°ƒè¯•é¢æ¿
      updateDebugPanel();
      
      return card;
    }
    
    /**
     * @function findRootContainer
     * @description æŸ¥æ‰¾å¡ç‰‡æ‰€å±çš„æ ¹å®¹å™¨
     * @param {string} cardId å¡ç‰‡ID
     * @returns {string} æ ¹å®¹å™¨ID
     */
    function findRootContainer(cardId) {
      // å¦‚æœæ˜¯æ ¹å¡ç‰‡ï¼Œç›´æ¥è¿”å›å…¶çˆ¶å®¹å™¨
      const card = document.getElementById(cardId);
      if (!card) return null;
      
      return card.parentElement.id;
    }
    
    /**
     * @function closeCard
     * @description å…³é—­å¡ç‰‡åŠå…¶æ‰€æœ‰å­å¡ç‰‡
     * @param {string} cardId è¦å…³é—­çš„å¡ç‰‡ID
     */
    function closeCard(cardId) {
      // æŸ¥æ‰¾æ‰€æœ‰å­å¡ç‰‡
      const childCardIds = [];
      for (const [childId, parentId] of directoryRelationships.entries()) {
        if (parentId === cardId) {
          childCardIds.push(childId);
        }
      }
      
      // é€’å½’å…³é—­æ‰€æœ‰å­å¡ç‰‡
      childCardIds.forEach(childId => closeCard(childId));
      
      // ç§»é™¤å…³ç³»è®°å½•
      directoryRelationships.delete(cardId);
      
      // ä»DOMä¸­ç§»é™¤å¡ç‰‡
      const card = document.getElementById(cardId);
      if (card) {
        const dirHandle = openedDirectories.get(cardId);
        if (dirHandle) {
          // ä»ç›®å½•å¥æŸ„æ˜ å°„ä¸­ç§»é™¤
          dirHandleMap.delete(dirHandle.name);
        }
        
        // ç§»é™¤è¿æ¥çº¿
        const connectors = document.querySelectorAll(`.connector-for-${cardId}`);
        connectors.forEach(connector => connector.remove());
        
        // ç§»é™¤é€‰ä¸­é¡¹è®°å½•
        selectedItemsPerCard.delete(cardId);
        
        // å¦‚æœæ˜¯æ ¹ç›®å½•å¡ç‰‡ï¼Œä¹Ÿç§»é™¤å…¶å®¹å™¨
        if (rootDirectories.has(cardId)) {
          rootDirectories.delete(cardId);
          const container = card.parentElement;
          if (container && container.classList.contains('root-directory-container')) {
            container.remove();
          }
        } else {
          card.remove();
        }
      }
      
      // ä»å·²æ‰“å¼€ç›®å½•ä¸­ç§»é™¤
      openedDirectories.delete(cardId);
      
      // æ›´æ–°è°ƒè¯•é¢æ¿
      updateDebugPanel();
    }
    
    /**
     * @function clearAllCards
     * @description æ¸…ç©ºæ‰€æœ‰å¡ç‰‡
     */
    function clearAllCards() {
      // å¤åˆ¶æ ¹ç›®å½•IDé›†åˆï¼Œå› ä¸ºåœ¨å¾ªç¯ä¸­ä¼šä¿®æ”¹é›†åˆ
      const rootIds = [...rootDirectories];
      
      // å…³é—­æ‰€æœ‰æ ¹ç›®å½•å¡ç‰‡
      rootIds.forEach(cardId => closeCard(cardId));
      
      // é‡ç½®çŠ¶æ€
      openedDirectories.clear();
      directoryRelationships.clear();
      rootDirectories.clear();
      selectedItemsPerCard.clear();
      dirHandleMap.clear();
      
      // æ¸…ç©ºç¼–è¾‘å™¨
      fileContentEditor.value = '';
      fileContentEditor.disabled = true;
      saveChangesButton.disabled = true;
      currentFileHandle = null;
      
      // ç§»é™¤ç¼–è¾‘å™¨æ ‡ç­¾
      const existingLabel = document.querySelector('.editor-label');
      if (existingLabel) {
        existingLabel.remove();
      }
      
      // æ›´æ–°è°ƒè¯•é¢æ¿
      updateDebugPanel();
    }
    
    /**
     * @function selectItem
     * @description é€‰ä¸­é¡¹ç›®å¹¶æ·»åŠ åˆ°å³ä¾§é¢æ¿
     * @param {string} cardId å¡ç‰‡ID
     * @param {string} itemType é¡¹ç›®ç±»å‹ ('file' æˆ– 'directory')
     * @param {string} itemName é¡¹ç›®åç§°
     */
    function selectItem(cardId, itemType, itemName) {
      // è·å–é€‰ä¸­é¡¹é›†åˆ
      if (!selectedItemsPerCard.has(cardId)) {
        selectedItemsPerCard.set(cardId, new Set());
      }
      const selectedItems = selectedItemsPerCard.get(cardId);
      
      // ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦
      const itemId = `${itemType}::${itemName}`;
      
      // å¦‚æœå·²é€‰ä¸­ï¼Œåˆ™ä¸é‡å¤æ·»åŠ 
      if (selectedItems.has(itemId)) {
        return;
      }
      
      // æ·»åŠ åˆ°é€‰ä¸­é›†åˆ
      selectedItems.add(itemId);
      
      // æ›´æ–°å³ä¾§é¢æ¿
      updateSelectedItemsPanel(cardId);
      
      // æ›´æ–°è°ƒè¯•é¢æ¿
      updateDebugPanel();
    }
    
    /**
     * @function removeSelectedItem
     * @description ä»é€‰ä¸­é¡¹ä¸­ç§»é™¤
     * @param {string} cardId å¡ç‰‡ID
     * @param {string} itemId é¡¹ç›®ID
     */
    function removeSelectedItem(cardId, itemId) {
      // è·å–é€‰ä¸­é¡¹é›†åˆ
      const selectedItems = selectedItemsPerCard.get(cardId);
      if (!selectedItems) return;
      
      // ä»é›†åˆä¸­ç§»é™¤
      selectedItems.delete(itemId);
      
      // æ›´æ–°å³ä¾§é¢æ¿
      updateSelectedItemsPanel(cardId);
      
      // æ›´æ–°è°ƒè¯•é¢æ¿
      updateDebugPanel();
    }
    
    /**
     * @function updateSelectedItemsPanel
     * @description æ›´æ–°å¡ç‰‡å³ä¾§çš„å·²é€‰ä¸­é¡¹é¢æ¿
     * @param {string} cardId å¡ç‰‡ID
     */
    function updateSelectedItemsPanel(cardId) {
      const card = document.getElementById(cardId);
      if (!card) return;
      
      const contentRight = card.querySelector('.content-right');
      const headerElement = contentRight.querySelector('.content-right-header');
      
      // æ¸…ç©ºç°æœ‰å†…å®¹ï¼Œä½†ä¿ç•™æ ‡é¢˜
      const children = Array.from(contentRight.children);
      children.forEach(child => {
        if (!child.classList.contains('content-right-header')) {
          child.remove();
        }
      });
      
      // è·å–é€‰ä¸­é¡¹é›†åˆ
      const selectedItems = selectedItemsPerCard.get(cardId);
      if (!selectedItems || selectedItems.size === 0) {
        // æ·»åŠ ç©ºé€‰æ‹©æç¤º
        const emptySelection = document.createElement('div');
        emptySelection.className = 'empty-selection';
        emptySelection.textContent = 'å³é”®ç‚¹å‡»å·¦ä¾§é¡¹ç›®æ¥é€‰æ‹©';
        contentRight.appendChild(emptySelection);
        return;
      }
      
      // æ·»åŠ æ‰€æœ‰é€‰ä¸­é¡¹
      selectedItems.forEach(itemId => {
        const [itemType, itemName] = itemId.split('::');
        
        const selectedItemElement = document.createElement('div');
        selectedItemElement.className = 'selected-item';
        selectedItemElement.dataset.id = itemId;
        
        // æ·»åŠ é¡¹ç›®å›¾æ ‡å’Œåç§°
        const icon = itemType === 'directory' ? 'ğŸ“' : 'ğŸ“„';
        selectedItemElement.innerHTML = `
          <div class="item-name"><span class="item-icon">${icon}</span> ${itemName}</div>
          <button class="remove-item" title="ç§»é™¤">Ã—</button>
        `;
        
        // æ·»åŠ ç§»é™¤æŒ‰é’®äº‹ä»¶
        const removeButton = selectedItemElement.querySelector('.remove-item');
        removeButton.addEventListener('click', () => {
          removeSelectedItem(cardId, itemId);
        });
        
        contentRight.appendChild(selectedItemElement);
      });
    }
    
    /**
     * @function fillCardWithDirectoryContents
     * @description å¡«å……å¡ç‰‡å†…å®¹åŒºåŸŸ
     * @param {HTMLElement} contentLeft å·¦ä¾§å†…å®¹å…ƒç´ 
     * @param {HTMLElement} cardInfo å¡ç‰‡ä¿¡æ¯å…ƒç´ 
     * @param {FileSystemDirectoryHandle} dirHandle ç›®å½•å¥æŸ„
     * @param {string} cardId å¡ç‰‡ID
     * @async
     */
    async function fillCardWithDirectoryContents(contentLeft, cardInfo, dirHandle, cardId) {
      try {
        // æ¸…ç©ºå¡ç‰‡å†…å®¹
        contentLeft.innerHTML = '';
        
        let fileCount = 0;
        let dirCount = 0;
        
        // éå†ç›®å½•å†…å®¹
        for await (const entry of dirHandle.values()) {
          const entryElement = document.createElement('div');
          
          if (entry.kind === 'directory') {
            dirCount++;
            entryElement.className = 'directory-item';
            entryElement.innerHTML = `<span class="item-icon">ğŸ“</span> ${entry.name}`;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆå·¦é”®ï¼‰
            entryElement.addEventListener('click', () => handleDirectoryClick(entry, cardId));
            
            // æ·»åŠ å³é”®äº‹ä»¶
            entryElement.addEventListener('contextmenu', (event) => {
              event.preventDefault(); // é˜»æ­¢é»˜è®¤å³é”®èœå•
              selectItem(cardId, 'directory', entry.name);
            });
          } else {
            fileCount++;
            entryElement.className = 'file-item';
            entryElement.innerHTML = `<span class="item-icon">ğŸ“„</span> ${entry.name}`;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆå·¦é”®ï¼‰
            entryElement.addEventListener('click', () => handleFileReadAsText(entry));
            
            // æ·»åŠ å³é”®äº‹ä»¶
            entryElement.addEventListener('contextmenu', (event) => {
              event.preventDefault(); // é˜»æ­¢é»˜è®¤å³é”®èœå•
              selectItem(cardId, 'file', entry.name);
            });
          }
          
          contentLeft.appendChild(entryElement);
        }
        
        // æ›´æ–°å¡ç‰‡ä¿¡æ¯
        cardInfo.textContent = `${dirCount} ä¸ªç›®å½•, ${fileCount} ä¸ªæ–‡ä»¶`;
      } catch (error) {
        contentLeft.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
        cardInfo.textContent = 'åŠ è½½å¤±è´¥';
        console.error('[DEBUG] ç›®å½•å†…å®¹åŠ è½½å¤±è´¥', error);
      }
    }

    /**
     * @function handleDirectorySelectionAndDisplay
     * @description å¤„ç†ç”¨æˆ·é€‰æ‹©ç›®å½•å¹¶å±•ç¤ºå…¶å†…å®¹
     * @async
     */
    async function handleDirectorySelectionAndDisplay() {
      try {
        // è¯·æ±‚è¯»å†™æƒé™ä»¥æ”¯æŒç¼–è¾‘æ“ä½œ
        const dirHandle = await window.showDirectoryPicker({
          mode: 'readwrite' // éœ€è¦è¯»å†™æƒé™
        });
        
        // æ£€æŸ¥ç›®å½•æ˜¯å¦å·²ç»æ‰“å¼€
        if (await isDirectoryAlreadyOpen(dirHandle)) {
          const existingCardId = getExistingCardId(dirHandle);
          if (existingCardId) {
            const card = document.getElementById(existingCardId);
            if (card) {
              // å·²æ‰“å¼€ç›®å½•ï¼Œæ»šåŠ¨åˆ°è¯¥å¡ç‰‡
              card.scrollIntoView({ behavior: 'smooth' });
              showStatusMessage(`ç›®å½• ${dirHandle.name} å·²ç»æ‰“å¼€`);
              return;
            }
          }
        }
        
        // åˆ›å»ºæ–°çš„æ ¹å®¹å™¨
        const containerId = createRootContainer();
        
        // åˆ›å»ºæ ¹ç›®å½•å¡ç‰‡
        const rootCard = createDirectoryCard(dirHandle.name, dirHandle, null, containerId);
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        showStatusMessage(`æˆåŠŸæ·»åŠ ç›®å½•: ${dirHandle.name}`);
      } catch (error) {
        console.error('[DEBUG] ç›®å½•é€‰æ‹©å¤±è´¥', error);
        showStatusMessage(`é€‰æ‹©ç›®å½•å¤±è´¥: ${error.message}`, true);
      }
    }
    
    /**
     * @function showStatusMessage
     * @description æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
     * @param {string} message æ¶ˆæ¯å†…å®¹
     * @param {boolean} isError æ˜¯å¦ä¸ºé”™è¯¯æ¶ˆæ¯
     */
    function showStatusMessage(message, isError = false) {
      // åˆ›å»ºæˆ–è·å–çŠ¶æ€æ¶ˆæ¯å…ƒç´ 
      let statusMessage = document.querySelector('.status-message');
      
      if (!statusMessage) {
        statusMessage = document.createElement('div');
        statusMessage.className = 'status-message';
        document.querySelector('.controls').insertAdjacentElement('afterend', statusMessage);
      }
      
      // è®¾ç½®æ¶ˆæ¯å†…å®¹å’Œæ ·å¼
      statusMessage.textContent = message;
      statusMessage.style.backgroundColor = isError ? '#ffebee' : '#e3f2fd';
      statusMessage.style.color = isError ? '#b71c1c' : '#0d47a1';
      
      // è‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
      setTimeout(() => {
        statusMessage.remove();
      }, 3000);
    }
    
    /**
     * @function createConnectorLines
     * @description åˆ›å»ºè¿æ¥çˆ¶å¡ç‰‡å’Œå­å¡ç‰‡çš„è¿æ¥çº¿
     * @param {HTMLElement} parentCard çˆ¶å¡ç‰‡å…ƒç´ 
     * @param {HTMLElement} childCard å­å¡ç‰‡å…ƒç´ 
     */
    function createConnectorLines(parentCard, childCard) {
      const parentRect = parentCard.getBoundingClientRect();
      const childRect = childCard.getBoundingClientRect();
      const containerRect = parentCard.parentElement.getBoundingClientRect();
      
      // è®¡ç®—ç›¸å¯¹äºå®¹å™¨çš„ä½ç½®
      const parentRelX = parentRect.left - containerRect.left + parentRect.width;
      const parentRelY = parentRect.top - containerRect.top + 40; // ä»å¡ç‰‡å¤´éƒ¨ä¸­é—´ä½ç½®
      const childRelX = childRect.left - containerRect.left;
      const childRelY = childRect.top - containerRect.top + 40; // åˆ°å¡ç‰‡å¤´éƒ¨ä¸­é—´ä½ç½®
      
      // åˆ›å»ºæ°´å¹³çº¿ï¼ˆä»çˆ¶å¡ç‰‡åˆ°å‚ç›´çº¿ï¼‰
      const horizontalLine = document.createElement('div');
      horizontalLine.className = `card-connector connector-horizontal connector-for-${childCard.id}`;
      horizontalLine.style.position = 'absolute';
      horizontalLine.style.left = `${parentRelX}px`;
      horizontalLine.style.top = `${parentRelY}px`;
      horizontalLine.style.width = `${(childRelX - parentRelX) / 2}px`;
      horizontalLine.style.height = '2px';
      parentCard.parentElement.appendChild(horizontalLine);
      
      // åˆ›å»ºå‚ç›´çº¿ï¼ˆè¿æ¥ä¸¤ä¸ªæ°´å¹³çº¿ï¼‰
      const verticalLine = document.createElement('div');
      verticalLine.className = `card-connector connector-vertical connector-for-${childCard.id}`;
      verticalLine.style.position = 'absolute';
      verticalLine.style.left = `${parentRelX + (childRelX - parentRelX) / 2}px`;
      verticalLine.style.top = `${Math.min(parentRelY, childRelY)}px`;
      verticalLine.style.width = '2px';
      verticalLine.style.height = `${Math.abs(childRelY - parentRelY)}px`;
      parentCard.parentElement.appendChild(verticalLine);
      
      // åˆ›å»ºæ°´å¹³çº¿ï¼ˆä»å‚ç›´çº¿åˆ°å­å¡ç‰‡ï¼‰
      const horizontalLine2 = document.createElement('div');
      horizontalLine2.className = `card-connector connector-horizontal connector-for-${childCard.id}`;
      horizontalLine2.style.position = 'absolute';
      horizontalLine2.style.left = `${parentRelX + (childRelX - parentRelX) / 2}px`;
      horizontalLine2.style.top = `${childRelY}px`;
      horizontalLine2.style.width = `${(childRelX - parentRelX) / 2}px`;
      horizontalLine2.style.height = '2px';
      parentCard.parentElement.appendChild(horizontalLine2);
      
      // ä¸ºäº¤å‰ç‚¹æ·»åŠ èŠ‚ç‚¹ç‚¹
      const node1 = document.createElement('div');
      node1.className = `connector-node connector-for-${childCard.id}`;
      node1.style.left = `${parentRelX + (childRelX - parentRelX) / 2 - 4}px`;
      node1.style.top = `${parentRelY - 4}px`;
      parentCard.parentElement.appendChild(node1);
      
      const node2 = document.createElement('div');
      node2.className = `connector-node connector-for-${childCard.id}`;
      node2.style.left = `${parentRelX + (childRelX - parentRelX) / 2 - 4}px`;
      node2.style.top = `${childRelY - 4}px`;
      parentCard.parentElement.appendChild(node2);
    }
    
    /**
     * @function handleDirectoryClick
     * @description å¤„ç†ç›®å½•ç‚¹å‡»ï¼Œæ‰“å¼€å­ç›®å½•
     * @param {FileSystemDirectoryHandle} dirHandle ç›®å½•å¥æŸ„
     * @param {string} parentCardId çˆ¶å¡ç‰‡ID
     * @async
     */
    async function handleDirectoryClick(dirHandle, parentCardId) {
      try {
        // æ£€æŸ¥ç›®å½•æ˜¯å¦å·²ç»æ‰“å¼€
        if (await isDirectoryAlreadyOpen(dirHandle)) {
          const existingCardId = getExistingCardId(dirHandle);
          if (existingCardId) {
            const card = document.getElementById(existingCardId);
            if (card) {
              // å·²æ‰“å¼€ç›®å½•ï¼Œæ»šåŠ¨åˆ°è¯¥å¡ç‰‡
              card.scrollIntoView({ behavior: 'smooth' });
              showStatusMessage(`ç›®å½• ${dirHandle.name} å·²ç»æ‰“å¼€`);
              return;
            }
          }
        }
        
        // è·å–çˆ¶å¡ç‰‡å’Œå®¹å™¨
        const parentCard = document.getElementById(parentCardId);
        if (!parentCard) {
          throw new Error('æ‰¾ä¸åˆ°çˆ¶å¡ç‰‡');
        }
        
        const containerID = findRootContainer(parentCardId);
        
        // åˆ›å»ºæ–°çš„ç›®å½•å¡ç‰‡
        const directoryCard = createDirectoryCard(dirHandle.name, dirHandle, parentCardId, containerID);
        
        // åˆ›å»ºè¿æ¥çº¿
        setTimeout(() => {
          createConnectorLines(parentCard, directoryCard);
        }, 10);
        
        // æ»šåŠ¨åˆ°æ–°å¡ç‰‡ä½ç½®
        directoryCard.scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error('[DEBUG] æ‰“å¼€å­ç›®å½•å¤±è´¥', error);
        showStatusMessage(`æ‰“å¼€ç›®å½•å¤±è´¥: ${error.message}`, true);
      }
    }

    /**
     * @function handleFileReadAsText
     * @description å°†æ–‡ä»¶ä½œä¸ºæ–‡æœ¬è¯»å–å¹¶æ˜¾ç¤º
     * @param {FileSystemFileHandle} fileHandle æ–‡ä»¶å¥æŸ„
     * @async
     */
    async function handleFileReadAsText(fileHandle) {
      try {
        const file = await fileHandle.getFile();
        const textContent = await file.text();
        
        fileContentEditor.value = textContent;
        fileContentEditor.disabled = false;
        saveChangesButton.disabled = false;
        currentFileHandle = fileHandle;
        
        // æ·»åŠ å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–‡ä»¶ä¿¡æ¯
        const editorLabel = document.createElement('div');
        editorLabel.textContent = `æ­£åœ¨ç¼–è¾‘: ${fileHandle.name}`;
        
        // å¦‚æœå·²ç»æœ‰æ ‡ç­¾ï¼Œåˆ™æ›¿æ¢å®ƒ
        const existingLabel = document.querySelector('.editor-label');
        if (existingLabel) {
          existingLabel.remove();
        }
        
        editorLabel.className = 'editor-label';
        document.querySelector('.editor-container').insertBefore(editorLabel, fileContentEditor);
        
        // æ»šåŠ¨åˆ°ç¼–è¾‘å™¨ä½ç½®
        fileContentEditor.scrollIntoView({ behavior: 'smooth' });
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        showStatusMessage(`å·²åŠ è½½æ–‡ä»¶: ${fileHandle.name}`);
        
        // æ›´æ–°è°ƒè¯•é¢æ¿
        updateDebugPanel();
      } catch (error) {
        console.error('[DEBUG] æ–‡ä»¶è¯»å–å¤±è´¥', error);
        showStatusMessage(`è¯»å–æ–‡ä»¶å¤±è´¥: ${error.message}`, true);
      }
    }

    /**
     * @function toggleCardCollapse
     * @description åˆ‡æ¢å¡ç‰‡çš„æ”¶èµ·/å±•å¼€çŠ¶æ€
     * @param {HTMLElement} card è¦åˆ‡æ¢çš„å¡ç‰‡å…ƒç´ 
     */
    function toggleCardCollapse(card) {
      const wasCollapsed = card.classList.contains('card-collapsed');
      card.classList.toggle('card-collapsed');
      
      // æ›´æ–°æ”¶èµ·/å±•å¼€æŒ‰é’®
      const collapseBtn = card.querySelector('.card-collapse-btn');
      if (collapseBtn) {
        if (card.classList.contains('card-collapsed')) {
          collapseBtn.innerHTML = 'â–¶';
          collapseBtn.title = 'å±•å¼€';
        } else {
          collapseBtn.innerHTML = 'â–¼';
          collapseBtn.title = 'æ”¶èµ·';
        }
      }
      
      // å½“å¡ç‰‡çŠ¶æ€å˜åŒ–æ—¶ï¼Œæ›´æ–°è¿æ¥çº¿
      setTimeout(() => {
        // é‡æ–°ç»˜åˆ¶ä¸æ­¤å¡ç‰‡ç›¸å…³çš„æ‰€æœ‰è¿æ¥çº¿
        updateConnectors();
      }, 10);
      
      // æ›´æ–°è°ƒè¯•é¢æ¿
      updateDebugPanel();
    }
    
    /**
     * @function updateConnectors
     * @description æ›´æ–°æ‰€æœ‰è¿æ¥çº¿ä½ç½®
     */
    function updateConnectors() {
      // ç§»é™¤æ‰€æœ‰è¿æ¥çº¿
      const connectors = document.querySelectorAll('.card-connector, .connector-node');
      connectors.forEach(connector => connector.remove());
      
      // é‡æ–°ç»˜åˆ¶æ‰€æœ‰è¿æ¥çº¿
      directoryRelationships.forEach((parentId, childId) => {
        const parentCard = document.getElementById(parentId);
        const childCard = document.getElementById(childId);
        if (parentCard && childCard) {
          createConnectorLines(parentCard, childCard);
        }
      });
    }
    
    /**
     * @function handleSaveFileChanges
     * @description å°†ç¼–è¾‘åçš„æ–‡æœ¬å†…å®¹ä¿å­˜å›åŸæ–‡ä»¶
     * @async
     */
    async function handleSaveFileChanges() {
      if (!currentFileHandle) {
        showStatusMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œç¼–è¾‘ï¼', true);
        return;
      }

      try {
        const writable = await currentFileHandle.createWritable();
        await writable.write(fileContentEditor.value);
        await writable.close();
        
        showStatusMessage(`æ–‡ä»¶ ${currentFileHandle.name} å·²æˆåŠŸä¿å­˜ï¼`);
      } catch (error) {
        console.error('[DEBUG] æ–‡ä»¶ä¿å­˜å¤±è´¥', error);
        showStatusMessage(`ä¿å­˜æ–‡ä»¶å¤±è´¥: ${error.message}`, true);
      }
    }

    // å¤„ç†çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°ç»˜åˆ¶è¿æ¥çº¿
    window.addEventListener('resize', updateConnectors);
    
    // æ·»åŠ æ”¶èµ·å…¨éƒ¨å’Œå±•å¼€å…¨éƒ¨åŠŸèƒ½
    function addCollapseAllButton() {
      const collapseAllButton = document.createElement('button');
      collapseAllButton.textContent = 'æ”¶èµ·å…¨éƒ¨';
      collapseAllButton.className = 'collapse-toggle-all';
      collapseAllButton.addEventListener('click', () => {
        const allCards = document.querySelectorAll('.directory-card');
        allCards.forEach(card => {
          if (!card.classList.contains('card-collapsed')) {
            toggleCardCollapse(card);
          }
        });
        updateDebugPanel();
        collapseAllButton.textContent = 'å±•å¼€å…¨éƒ¨';
        collapseAllButton.onclick = expandAllCards;
      });
      
      function expandAllCards() {
        const allCards = document.querySelectorAll('.directory-card');
        allCards.forEach(card => {
          if (card.classList.contains('card-collapsed')) {
            toggleCardCollapse(card);
          }
        });
        updateDebugPanel();
        collapseAllButton.textContent = 'æ”¶èµ·å…¨éƒ¨';
        collapseAllButton.onclick = collapseAllButton.addEventListener('click', () => {
          const allCards = document.querySelectorAll('.directory-card');
          allCards.forEach(card => {
            if (!card.classList.contains('card-collapsed')) {
              toggleCardCollapse(card);
            }
          });
          updateDebugPanel();
          collapseAllButton.textContent = 'å±•å¼€å…¨éƒ¨';
          collapseAllButton.onclick = expandAllCards;
        });
      }
      
      // æ·»åŠ åˆ°æ§åˆ¶åŒºåŸŸ
      document.querySelector('.controls').appendChild(collapseAllButton);
    }
    
    // åˆå§‹åŒ–æ”¶èµ·å…¨éƒ¨æŒ‰é’®
    addCollapseAllButton();

    // ç»‘å®šäº‹ä»¶
    addDirectoryButton.addEventListener('click', handleDirectorySelectionAndDisplay);
    clearAllButton.addEventListener('click', clearAllCards);
    saveChangesButton.addEventListener('click', handleSaveFileChanges);
    
    // åˆå§‹åŒ–è°ƒè¯•é¢æ¿
    updateDebugPanel();
  </script>
</body>
</html>